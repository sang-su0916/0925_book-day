<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 페이지</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>GitHub Pages vs 로컬 환경 테스트</h1>

    <div id="environment" class="result info">
        <strong>현재 환경:</strong> <span id="envType"></span>
    </div>

    <button onclick="testGoogleAppsScript()">Google Apps Script 연결 테스트</button>
    <button onclick="testFormSubmission()">폼 제출 테스트</button>
    <button onclick="testCORS()">CORS 테스트</button>

    <div id="results"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbywAoZTk5vSgJSxfb7Ih1U5F9gGVMKVyNEz1RWZ8UJvZRaOoYv97b_dl4z0oZ5iE8jb/exec';

        // 환경 감지
        document.getElementById('envType').textContent =
            location.protocol === 'file:' ? '로컬 파일' :
            location.hostname.includes('github.io') ? 'GitHub Pages' : '기타 웹서버';

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            document.getElementById('results').appendChild(div);
        }

        async function testGoogleAppsScript() {
            addResult('Google Apps Script GET 요청 테스트 중...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                const text = await response.text();
                addResult(`GET 응답 성공: ${text.substring(0, 100)}...`, 'success');

                try {
                    const json = JSON.parse(text);
                    addResult(`JSON 파싱 성공: ${json.message}`, 'success');
                } catch(e) {
                    addResult(`JSON 파싱 실패, 텍스트 응답: ${text}`, 'error');
                }

            } catch (error) {
                addResult(`GET 요청 실패: ${error.message}`, 'error');
            }
        }

        async function testFormSubmission() {
            addResult('폼 제출 테스트 중...', 'info');

            const testData = {
                name: '테스트사용자_' + Date.now(),
                phone: '010-1234-5678',
                email: 'test@test.com'
            };

            try {
                // 방법 1: FormData
                const formData = new FormData();
                formData.append('data', JSON.stringify(testData));

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                addResult(`POST 응답: ${result.substring(0, 200)}...`, 'success');

            } catch (error) {
                addResult(`POST 요청 실패: ${error.message}`, 'error');

                // 방법 2: iframe 방식 시도
                try {
                    addResult('iframe 방식으로 재시도...', 'info');
                    await submitViaIframe(testData);
                    addResult('iframe 제출 완료 (응답 확인 불가)', 'success');
                } catch(e) {
                    addResult(`iframe 방식도 실패: ${e.message}`, 'error');
                }
            }
        }

        async function submitViaIframe(data) {
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.name = 'test_frame';
                document.body.appendChild(iframe);

                const form = document.createElement('form');
                form.target = 'test_frame';
                form.method = 'POST';
                form.action = API_URL;
                form.style.display = 'none';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'data';
                input.value = JSON.stringify(data);
                form.appendChild(input);

                document.body.appendChild(form);

                iframe.onload = () => {
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        document.body.removeChild(form);
                        resolve();
                    }, 2000);
                };

                iframe.onerror = () => {
                    document.body.removeChild(iframe);
                    document.body.removeChild(form);
                    reject(new Error('iframe 오류'));
                };

                form.submit();

                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                        document.body.removeChild(form);
                        reject(new Error('타임아웃'));
                    }
                }, 10000);
            });
        }

        async function testCORS() {
            addResult('CORS 정책 테스트 중...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'OPTIONS'
                });
                addResult(`OPTIONS 요청 성공: ${response.status}`, 'success');
            } catch (error) {
                addResult(`OPTIONS 요청 실패: ${error.message}`, 'error');
            }

            // 환경 정보 출력
            addResult(`현재 URL: ${location.href}`, 'info');
            addResult(`프로토콜: ${location.protocol}`, 'info');
            addResult(`호스트: ${location.host}`, 'info');
            addResult(`User Agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');
        }

        // 페이지 로드 시 자동 환경 테스트
        window.addEventListener('load', () => {
            addResult('페이지 로드 완료, 환경 정보 수집 중...', 'info');
            testCORS();
        });
    </script>
</body>
</html>